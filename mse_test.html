<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>浏览器JS测试页面</title>
    <link rel="stylesheet" href="./data/css/style.css" />
    <style>
      body {
        font-family: Arial, sans-serif;
      }

      ul {
        list-style-type: none;
        padding: 0;
      }

      li {
        display: block;
        text-decoration: none;
        color: #000;
        background-color: #f2f2f2;
        padding: 10px;
        margin: 5px;
        border-radius: 5px;
      }

      li a {
        color: inherit;
        text-decoration: none;
        width: 100%;
        height: 100%;
        display: block;
      }

      li:hover {
        background-color: #ddd;
      }
    </style>

    <style>
      #consoleOutput {
        background-color: #f4f4f4;
        border: 1px solid #ddd;
        padding: 10px;
        max-height: 300px;
        overflow-y: auto;
        white-space: pre-wrap;
        margin: 5px;
      }
    </style>

    <style>
      /* 默认样式（亮模式） */
      div {
        background-color: #ffffff; /* 亮模式下的背景色 */
        color: #000000; /* 亮模式下的文字颜色 */
      }

      /* 夜间模式下的样式 */
      @media (prefers-color-scheme: dark) {
        div {
          background-color: #333333; /* 夜间模式下的背景色 */
          color: #ffffff; /* 夜间模式下的文字颜色 */
        }
      }
    </style>
  </head>

  <body>
    <ul>
      <div
        id="uaInfo"
        style="margin: 5px; padding: 10px; border: 1px solid gray"
      ></div>
      <img id="imageIcon" />
      <li id="closePage">closePage(关闭页面)</li>
      <li id="onBackPressed">onBackPressed(返回)</li>
      <hr />
      <li id="openCrxManagerPage">openCrxManagerPage(本地扩展管理页面)</li>
      <li id="isSettingsEnabled">isSettingsEnabled(扩展功能开关)</li>

      <hr />
      <label for="responsibility">Choose a responsibility:</label>
      <select id="responsibility" name="responsibility">
        <option value="project_management">Project Management</option>
        <option value="software_development">Software Development</option>
        <option value="system_design">System Design</option>
        <option value="quality_assurance">Quality Assurance</option>
        <option value="technical_support">Technical Support</option>
      </select>
      <hr />

      <!-- 添加一个分割线 -->
      <li
        class="InstallExtension"
        ext-id="ddkjiahejlhfcafbddmgiahcphecmpfh"
        ext-name="uBlock-Origin-Lite-2024.9.12.1004"
      >
        installExtension(uBlock-Origin-Lite-2024.9.12.1004)
      </li>
      <li
        class="InstallExtension"
        ext-id="bpoadfkcbjbfhfodiogcnhhhpibjhbnh"
        ext-name="沉浸式翻译-1.9.6"
      >
        installExtension(沉浸式翻译-1.9.6)
      </li>

      <details>
        <summary>扩展列表-V1</summary>
        <li
          class="InstallExtension"
          ext-id="eimadpbcbfnmbkopoojfekhnkhdbieeh"
          ext-name="dark-reader_4.9.88"
        >
          installExtension(dark-reader_4.9.88)
        </li>
        <li
          class="InstallExtension"
          ext-id="jpbjcnkcffbooppibceonlgknpkniiff"
          ext-name="Global-Speed-3.0.9971"
        >
          installExtension(Global-Speed-3.0.9971)
        </li>
        <li
          class="InstallExtension"
          ext-id="lobgmjplponpghhahhmpfhnaiegjipaf"
          ext-name="Easy-QR-Code-1.0.7"
        >
          installExtension(Easy-QR-Code-1.0.7)
        </li>
        <li
          class="InstallExtension"
          ext-id="hlkenndednhfkekhgcdicdfddnkalmdm"
          ext-name="Cookie-Editor-1.13.0"
        >
          installExtension(Cookie_Editor_1.13.0)
        </li>
        <li
          class="InstallExtension"
          ext-id="okckmdcaaieknndlpbpjjnfmbakdjnbe"
          ext-name="Cookie-Manager-0.0.2"
        >
          installExtension(Cookie-Manager-0.0.2)
        </li>
        <li
          class="InstallExtension"
          ext-id="edibdbjcniadpccecjdfdjjppcpchdlm"
          ext-name="i-still-dont-care-about-cookie-1.1.4"
        >
          installExtension(i-still-dont-care-about-cookie-1.1.4)
        </li>
        <li
          class="InstallExtension"
          ext-id="gcckmgpflcgmojmpblplppomkmcdjlan"
          ext-name="找券券_3.3.3"
        >
          installExtension(找券券_3.3.3)
        </li>
      </details>
      <hr />
      <!-- 添加一个分割线 -->
      
      <li id="installLocalExtension">installLocalExtension(安装本地扩展)</li>
      <li id="getDevModeEnabled">getDevModeEnabled(获取开发者模式状态)</li>
      <li id="setDevModeEnabled">setDevModeEnabled(修改开发者模式)</li>
      
      
      <li id="getInstallState">getInstallState(获取扩展安装状态)</li>
      <li id="getExtensionIcon">getExtensionIcon(获取扩展ICON)</li>
      <li id="getInstalledItems">getInstalledItems(获取已安装扩展列表)</li>
      <li id="removeExtension">removeExtension(删除扩展)</li>
      <li id="changeExtensionState">changeExtensionState(禁用启用扩展)</li>
      <li id="isExtensionEnabled">isExtensionEnabled(扩展是否可用)</li>
      
      <hr />
      <!-- 添加一个分割线 -->
      <li>
        <a href="chrome-error://chromewebdata/" target="_blank"
          >chrome-error://chromewebdata/</a
        >
      </li>
      <li id="windowOpenUrl">windowOpen(github)</li>
      <li id="closeWindow">closeWindow()</li>
      <li><a href="https://www.baidu.com" target="_blank">百度</a></li>
      <li><a href="https://www.sina.cn" target="_blank">新浪</a></li>
      <li>
        <a
          href="https://storage.pangdasc.com/pages/771427447166/landing_mt9_page.html?mediaPlatformType=9&source_id={source_id}&advertiserId=1264047&planid={planid}&keywordid={keywordid}&creativeid={creativeid}&groupid={groupid}&device={device}&t=1711608465876"
          target="_blank"
          >测试页面</a
        >
      </li>

      <li id="showUA">点击显示UA</li>
    </ul>
    <div id="popup" class="popup">
      <p id="popup-message"></p>
      <button onclick="closePopup()">关闭</button>
    </div>

    <div id="toast" class="toast">
      <span class="message">This is a toast message!</span>
    </div>
    <hr />
    <!-- 添加一个分割线 -->
    <h2 style="margin: 5px">Console Output:</h2>
    <div id="consoleOutput"></div>
    <script>
      function showPopup(message) {
        const popup = document.getElementById("popup");
        document.getElementById("popup-message").textContent = message; // 设置弹窗内容
        popup.classList.add("show");
      }
      function closePopup() {
        const popup = document.getElementById("popup");
        popup.classList.remove("show");
      }

      function showToast(message, duration = 3000) {
        const toast = document.getElementById("toast");
        toast.querySelector(".message").textContent = message;
        toast.classList.add("show");

        setTimeout(() => {
          toast.classList.remove("show");
        }, duration);
      }

      // 创建事件处理函数
      function showUserAgent() {
        // 获取用户代理信息
        const userAgent = navigator.userAgent;
        // 显示用户代理信息
        showPopup("User Agent: " + userAgent);
      }
      function applyTheme() {
        const isDarkMode =
          window.matchMedia &&
          window.matchMedia("(prefers-color-scheme: dark)").matches;
        var backgroundColor = window.getComputedStyle(
          document.body
        ).backgroundColor;

        document.getElementById("uaInfo").innerHTML =
          "UA：" +
          navigator.userAgent +
          " isDarkMode=" +
          isDarkMode +
          " backgroundColor=" +
          backgroundColor;

        if (isDarkMode) {
          // document.body.style.backgroundColor = "#1a1a1a"; // Dark mode background color
          // document.body.style.color = "#ffffff"; // Dark mode text color
        } else {
          // document.body.style.backgroundColor = "#ffffff"; // Light mode background color
          // document.body.style.color = "#000000"; // Light mode text color
        }

        console.log(
          "isDarkMode =",
          isDarkMode,
          "backgroundColor=",
          backgroundColor
        );
      }

      // Listen for changes in the prefers-color-scheme setting
      window
        .matchMedia("(prefers-color-scheme: dark)")
        .addEventListener("change", applyTheme);

      // Apply the theme on initial load
      applyTheme();
      document.getElementById("showUA").addEventListener("click", function () {
        showUserAgent();
      });

      // 保存原始 console.log 方法
      const originalConsoleLog = console.log;

      // 获取显示区域的引用
      const outputElement = document.getElementById("consoleOutput");

      // 自定义 console.log 方法
      console.log = function (...args) {
        // 将消息格式化为字符串
        const message = args
          .map((arg) => (typeof arg === "object" ? JSON.stringify(arg) : arg))
          .join(" ");

        // 在网页上显示日志
        const timestamp = new Date().toLocaleString();
        outputElement.innerHTML += `[${timestamp}] ${message}<br>`;

        // 也输出到控制台
        originalConsoleLog.apply(console, args);
      };

      function getDownlodUrl(name) {
        return `https://bineanzhou.github.io/dev.github.io/data/crx/${name}.crx`;
      }

      function delay(ms) {
        return new Promise((resolve) => {
          setTimeout(resolve, ms);
        });
      }

      function closePage() {
        var reqID = randomString(8);
        A3ExtMessage.send(
          "$a3com_message_cmd:closePage",
          {},
          {
            requestID: reqID,
          }
        );
      }
      function onBackPressed() {
        var reqID = randomString(8);
        A3ExtMessage.send(
          "$a3com_message_cmd:onBackPressed",
          {},
          {
            requestID: reqID,
          }
        );
      }
      async function installLocalExtension() {
        var reqID = randomString(8);

        A3ExtMessage.send(
          "$a3ext_message_cmd:installLocalExtension",
          {  },
          {
            requestID: reqID,
          }
        );
      }
      async function installExtension() {
        var reqID = randomString(8);

        // 显示确认对话框
        var result = confirm(`是否安装扩展 ${window.EXT_ID}?`);
        if (!result) {
          return false;
        }

        A3ExtMessage.send(
          "$a3ext_message_cmd:installExtension",
          { id: window.EXT_ID, url: getDownlodUrl(window.EXT_NAME) },
          {
            requestID: reqID,
          }
        );

        if (!isAndroid()) {
          mockClientMessage("installExtension", {
            requestID: reqID,
            common: {},
          });

          A3OnExtMessage(
            `notifyInstallState`,
            `${JSON.stringify({
              requestID: reqID,
              data: { id: window.EXT_ID, state: 1 },
            })}`
          );

          await delay(1000); // 等待 1 秒

          A3OnExtMessage(
            `notifyInstallState`,
            `${JSON.stringify({
              requestID: reqID,
              data: { id: window.EXT_ID, state: 2 },
            })}`
          );

          await delay(1000); // 等待 1 秒

          A3OnExtMessage(
            `notifyInstallState`,
            `${JSON.stringify({
              requestID: reqID,
              data: { id: window.EXT_ID, state: 3 },
            })}`
          );
        }
      }

      function changeExtensionState() {
        var reqID = randomString(8);

        var enable = Math.random() >= 0.5;
        var stateName = "";
        if (enable) {
          stateName = "启用";
        } else {
          stateName = "禁用";
        }

        A3ExtMessage.send(
          "$a3ext_message_cmd:changeExtensionState",
          { id: window.EXT_ID, state: enable ? "ENABLED" : "DISABLED" },
          {
            requestID: reqID,
          }
        );

        var result = Math.random() >= 0.5;
        mockClientMessage("changeExtensionState", {
          requestID: reqID,
          common: {},
          errCode: 0,
          errMessage: result ? `${stateName}成功！` : `${stateName}失败!`,
          data: enable,
        });
      }

      function getRandomInt(min, max) {
        min = Math.ceil(min);
        max = Math.floor(max);
        return Math.floor(Math.random() * (max - min + 1)) + min;
      }

      function windowOpenUrl() {
        // console.log("windowOpenUrl");
        // window.open("https://m.so.com", "blank");
        
        const popup = window.open("https://bineanzhou.github.io/dev.github.io/mse_test.html", "example", "width=600,height=600");
      }
      function closeWindow() {
        console.log("closeWindow");
        window.close();
      }
      async function isExtensionEnabled() {
        var reqID = randomString(8);

        A3ExtMessage.send(
          "$a3ext_message_cmd:isExtensionEnabled",
          { id: window.EXT_ID },
          {
            requestID: reqID,
          }
        );

        var result = Math.random() >= 0.5;

        mockClientMessage("isExtensionEnabled", {
          requestID: reqID,
          common: {},
          errCode: 0,
          errMessage: "ok",
          data: result,
        });
      }
      
      async function getDevModeEnabled() {
        var reqID = randomString(8);

        A3ExtMessage.send(
          "$a3com_message_cmd:getDevModeEnabled",
          { },
          {
            requestID: reqID,
          }
        );

        var result = Math.random() >= 0.5;
        mockClientMessage("getDevModeEnabled", {
          requestID: reqID,
          common: {},
          errCode: 0,
          errMessage: "ok",
          data: result,
        });
      }
      
      async function setDevModeEnabled() {
        var reqID = randomString(8);

        var result = Math.random() >= 0.5;
        A3ExtMessage.send(
          "$a3com_message_cmd:setDevModeEnabled",
          { enable: result },
          {
            requestID: reqID,
          }
        );

        mockClientMessage("setDevModeEnabled", {
          requestID: reqID,
          common: {},
          errCode: 0,
          errMessage: "ok",
          data: result,
        });
      }

      async function getInstallState() {
        var reqID = randomString(8);

        A3ExtMessage.send(
          "$a3ext_message_cmd:getInstallState",
          { id: window.EXT_ID },
          {
            requestID: reqID,
          }
        );

        // STATE_IDLE(0),
        // STATE_INSTALL_START(1),
        // STATE_INSTALLING(2),
        // STATE_INSTALLED(3);
        var state = getRandomInt(0, 3);

        mockClientMessage("getInstallState", {
          requestID: reqID,
          common: {},
          errCode: 0,
          errMessage: "ok",
          data: { state: state },
        });
      }

      async function removeExtension() {
        var reqID = randomString(8);

        // 显示确认对话框
        var result = confirm(`是否卸载扩展 ${window.EXT_ID}?`);
        if (!result) {
          return false;
        }

        A3ExtMessage.send(
          "$a3ext_message_cmd:removeExtension",
          { id: window.EXT_ID },
          {
            requestID: reqID,
          }
        );

        var result = Math.random() >= 0.5;

        mockClientMessage("removeExtension", {
          requestID: reqID,
          common: {},
          errCode: 0,
          errMessage: result ? "删除成功！" : "删除失败!",
          data: result,
        });
      }

      function openCrxManagerPage() {
        //发送请求给客户端
        var reqID = randomString(8);
        A3ExtMessage.send(
          "$a3ext_message_cmd:openCrxManagerPage",
          { id: window.EXT_ID },
          {
            requestID: reqID,
          }
        );

        mockClientMessage("openCrxManagerPage", {
          requestID: reqID,
          common: {},
        });
      }
      

      function getExtensionIcon() {
        //发送请求给客户端
        var reqID = randomString(8);
        A3ExtMessage.send(
          "$a3ext_message_cmd:getExtensionIcon",
          { id: window.EXT_ID },
          {
            requestID: reqID,
          }
        );

        mockClientMessage("getExtensionIcon", {
          requestID: reqID,
          errCode: 0,
          errMessage: "ok",
          data: "data:image/png;base64,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",
          common: {},
        });
      }
      function isSettingsEnabled() {
        //发送请求给客户端
        var reqID = randomString(8);
        A3ExtMessage.send(
          "$a3ext_message_cmd:isSettingsEnabled",
          { id: window.EXT_ID },
          {
            requestID: reqID,
          }
        );

        mockClientMessage("isSettingsEnabled", {
          requestID: reqID,
          errCode: 0,
          errMessage: "ok",
          data: true,
          common: {},
        });
      }
      function getInstalledItems() {
        var reqID = randomString(8);
        //发送请求给客户端
        A3ExtMessage.send(
          "$a3ext_message_cmd:getInstalledItems",
          {},
          {
            requestID: reqID,
          }
        );

        //模拟客户端收到消息调用前端方法回传列表
        mockClientMessage("getInstalledItems", {
          requestID: reqID,
          common: {},
          errCode: 0,
          errMessage: "ok",
          data: [
            {
              id: window.EXT_ID,
              name: "Dark Reader",
              description: "Dark Reader",
              state: "ENABLED",
              version: "4.9.88",
            },
          ],
        });
      }

      function isAndroid() {
        return /Android/i.test(navigator.userAgent);
      }
      function mockClientMessage(type, clientData) {
        var enable = !isAndroid();
        if (enable) {
          const clientDataJson = JSON.stringify(clientData);
          //客户端直接执行window上方法
          console.log(`非Android mock client:`, clientDataJson);
          A3OnExtMessage(type, clientDataJson);
        }
      }

      function randomString(len) {
        len = len || 32;
        var $chars =
          "ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678"; /****默认去掉了容易混淆的字符oOLl,9gq,Vv,Uu,I1****/
        var maxPos = $chars.length;
        var pwd = "";
        for (let i = 0; i < len; i++) {
          pwd += $chars.charAt(Math.floor(Math.random() * maxPos));
        }
        return pwd;
      }
      let requestDataCache = {};
      function cacheRequestData(requestID, requestData) {
        requestDataCache[requestID] = requestData;
      }

      function A3MessageSend() {
        let EventCallbacks = {};

        let msgObj = {
          send: function (type, data, clientData) {
            const requestID = clientData?.requestID || randomString(8);
            const resp = {
              errCode: 0,
              errMessage: "ok",
              data: data,
              requestID,
            };
            cacheRequestData(requestID, data);
            const content = `${type}:${JSON.stringify(resp)}`;
            console.log(`前端发送请求:`);
            console.log(content);
            try {
              window.webkit.messageHandlers.ai_ext_message.postMessage(content);
            } catch (error) {}
          },
          on: function (type, func) {
            if (!EventCallbacks[type]) {
              EventCallbacks[type] = [];
            }
            EventCallbacks[type].push(func);
          },
          onMessage: function (type, data, ...args) {
            console.log(`客户端回传请求：${type}---`, data);
            if (type && EventCallbacks[type]) {
              let ret = false,
                cbs = EventCallbacks[type];
              cbs.forEach(function (cb, idx) {
                let parseData = "";
                try {
                  parseData = JSON.parse(data);
                } catch (error) {
                  parseData = data;
                }
                requestID = parseData.requestID;
                let requestData = {};
                if (requestDataCache[requestID]) {
                  requestData = requestDataCache[requestID];
                  delete requestDataCache[requestID];
                  console.log(`请求参数：${requestID}---`, requestData);
                }
                ret = cb.apply(null, [requestData, parseData, ...args]) || ret;
              });
              console.log(`ret:${ret}`);
              return ret;
            }
            return false;
          },
        };
        return msgObj;
      }

      function changeImage(imageSrc) {
        const imgElement = document.getElementById("imageIcon");
        imgElement.src = imageSrc;

        // 设置新的图片加载完成时的处理
        imgElement.onload = function () {
          const originalWidth = imgElement.naturalWidth;
          const originalHeight = imgElement.naturalHeight;

          // 设置 img 元素的宽度和高度为图片的原始尺寸
          imgElement.width = originalWidth;
          imgElement.height = originalHeight;
        };
      }

      function extEvent() {
        //客户端扩展列表数据
        window.A3ExtMessage.on(
          "isSettingsEnabled",
          (requestData, clientData) => {
            console.log(`前端收到客户端 isSettingsEnabled：`, clientData);
            if (clientData.data) showToast(`扩展功能可用!`);
            else showToast(`扩展功能不可用`);
            return true;
          }
        );
        window.A3ExtMessage.on(
          "getInstalledItems",
          (requestData, clientData) => {
            console.log(`前端收到客户端 getInstalledItems：`, clientData);
            alert(JSON.stringify(clientData, null, 2));
            return true;
          }
        );

        window.A3ExtMessage.on(
          "installExtension",
          (requestData, clientData) => {
            console.log(`前端收到客户端 installExtension`, clientData);
            return true;
          }
        );

        window.A3ExtMessage.on(
          "getExtensionIcon",
          (requestData, clientData) => {
            console.log(
              `前端收到客户端 getExtensionIcon`,
              requestData,
              clientData
            );
            if (clientData.errCode == 0) {
              // alert(clientData.data)
              changeImage(clientData.data);
            } else {
              showToast(`${window.EXT_ID} ${clientData.errMessage}`);
            }

            return true;
          }
        );

        window.A3ExtMessage.on("removeExtension", (requestData, clientData) => {
          console.log(`前端收到客户端 removeExtension`, clientData);
          showToast(`${window.EXT_ID} ${clientData.errMessage}`);
          return true;
        });

        window.A3ExtMessage.on(
          "isExtensionEnabled",
          (requestData, clientData) => {
            console.log(`前端收到客户端 isExtensionEnabled`, clientData);

            if (clientData.errCode != 0) {
              showToast(`${window.EXT_ID} ${clientData.errMessage}`);
              return true;
            }
            if (clientData.data == true) {
              showToast(`${window.EXT_ID} 扩展已启用!`);
            } else {
              showToast(`${window.EXT_ID} 扩展已禁用!`);
            }
            return true;
          }
        );
        window.A3ExtMessage.on(
          "installLocalExtension",
          (requestData, clientData) => {
            console.log(`前端收到客户端 getDevModeEnabled`, clientData);
            if (clientData.errCode != 0) {
              showToast(`${clientData.errMessage}`);
              return true;
            }
            return true;
          }
        );
        window.A3ExtMessage.on(
          "getDevModeEnabled",
          (requestData, clientData) => {
            console.log(`前端收到客户端 getDevModeEnabled`, clientData);

            if (clientData.errCode != 0) {
              showToast(`${clientData.errMessage}`);
              return true;
            }
            if (clientData.data == true) {
              window.DEV_MODE_ENABLED = true;
              showToast(`已开启开发者模式!`);
            } else {
              window.DEV_MODE_ENABLED = false;
              showToast(`已关闭开发者模式!`);
            }
            return true;
          }
        );
        window.A3ExtMessage.on(
          "setDevModeEnabled",
          (requestData, clientData) => {
            console.log(`前端收到客户端 setDevModeEnabled`, clientData);

            if (clientData.errCode != 0) {
              showToast(`${clientData.errMessage}`);
              return true;
            }
            if (clientData.data == true) {
              window.DEV_MODE_ENABLED = true;
              showToast(`已开启开发者模式!`);
            } else {
              window.DEV_MODE_ENABLED = false;
              showToast(`已关闭开发者模式!`);
            }
            return true;
          }
        );

        window.A3ExtMessage.on(
          "changeExtensionState",
          (requestData, clientData) => {
            console.log(`前端收到客户端 changeExtensionState`, clientData);
            showToast(`${window.EXT_ID} ${clientData.errMessage}`);
            return true;
          }
        );
        window.A3ExtMessage.on(
          "notifyInstallState",
          (requestData, clientData) => {
            console.log(`前端收到客户端 notifyInstallState`, clientData);
            if (clientData.data.state == 1) {
              showToast(`${clientData.data.id} 开始安装`);
            } else if (clientData.data.state == 2) {
              showToast(`${clientData.data.id} 安装中...`);
            } else if (clientData.data.state == 3) {
              showToast(`${clientData.data.id} 扩展安装成功!`);
            } else {
              showToast(`${clientData.data.id} ${clientData.data.errMessage}!`);
            }
            return true;
          }
        );
      }
      function init() {
        if (window._A3_EXTENSION_WEBQUERY_INIT) return;
        window._A3_EXTENSION_WEBQUERY_INIT = true;
        window.EXT_ID = "ifoakfbpdcdoeenechcleahebpibofpc";
        window.DEV_MODE_ENABLED = false;
        window.EXT_NAME = "Dark_Reader_4.9.87";
        console.log("ext init");
        if (!window.A3ExtMessage) {
          let A3ExtMessage = A3MessageSend();
          window.A3ExtMessage = A3ExtMessage;
          window.A3OnExtMessage = A3ExtMessage.onMessage;
        }

        document
          .getElementById("getInstalledItems")
          .addEventListener("click", getInstalledItems);

        document
          .getElementById("isSettingsEnabled")
          .addEventListener("click", isSettingsEnabled);

        const items = document.querySelectorAll(".InstallExtension");

        items.forEach((item) => {
          item.addEventListener("click", function () {
            // 获取 ext-id 属性

            window.EXT_ID = this.getAttribute("ext-id");
            window.EXT_NAME = this.getAttribute("ext-name");
            console.log("installElement", this.getAttribute("ext-id"));
            installExtension();
          });
        });

        document
          .getElementById("closePage")
          .addEventListener("click", closePage);
        document
          .getElementById("onBackPressed")
          .addEventListener("click", onBackPressed);

        document
          .getElementById("removeExtension")
          .addEventListener("click", removeExtension);

        document
          .getElementById("openCrxManagerPage")
          .addEventListener("click", openCrxManagerPage);

        document
          .getElementById("changeExtensionState")
          .addEventListener("click", changeExtensionState);

        document
          .getElementById("getInstallState")
          .addEventListener("click", getInstallState);

        document
          .getElementById("isExtensionEnabled")
          .addEventListener("click", isExtensionEnabled);
          
        document
          .getElementById("installLocalExtension")
          .addEventListener("click", installLocalExtension);
        document
        document
          .getElementById("getDevModeEnabled")
          .addEventListener("click", getDevModeEnabled);
        document
          .getElementById("setDevModeEnabled")
          .addEventListener("click", setDevModeEnabled);
          
        document
          .getElementById("getExtensionIcon")
          .addEventListener("click", getExtensionIcon);

        document
          .getElementById("windowOpenUrl")
          .addEventListener("click", windowOpenUrl);
        document
          .getElementById("closeWindow")
          .addEventListener("click", closeWindow);
          
        extEvent();
      }

      init();
    </script>
  </body>
</html>
